<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直接ASR测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        .button.success { background-color: #28a745; color: white; }
        .button.danger { background-color: #dc3545; color: white; }
        .button.primary { background-color: #007bff; color: white; }
        .button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .result {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
            font-size: 18px;
        }
        .result.success { background-color: #d4edda; color: #155724; }
        .result.error { background-color: #f8d7da; color: #721c24; }
        .result.warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 直接ASR测试</h1>
        <p><strong>目标：</strong>绕过所有复杂逻辑，直接测试最基本的录音和识别</p>
        
        <div class="controls">
            <button id="recordBtn" class="button success">🎤 录音5秒</button>
            <button id="testWavBtn" class="button primary">📁 测试WAV文件</button>
            <button id="testTextBtn" class="button primary">📝 测试固定文本</button>
        </div>
        
        <div id="result" class="result">等待测试...</div>
        
        <div class="container">
            <h3>📝 测试日志</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const testWavBtn = document.getElementById('testWavBtn');
        const testTextBtn = document.getElementById('testTextBtn');
        const result = document.getElementById('result');
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function updateResult(text, type = '') {
            result.innerHTML = text;
            result.className = 'result ' + type;
        }
        
        // 创建一个最小的WAV文件（1秒，16kHz，单声道，静音）
        function createMinimalWav() {
            const sampleRate = 16000;
            const duration = 1; // 1秒
            const samples = sampleRate * duration;
            const buffer = new ArrayBuffer(44 + samples * 2);
            const view = new DataView(buffer);
            
            // WAV文件头
            let offset = 0;
            
            // RIFF
            view.setUint32(offset, 0x46464952, false); offset += 4; // "RIFF"
            view.setUint32(offset, 36 + samples * 2, true); offset += 4; // 文件大小
            view.setUint32(offset, 0x45564157, false); offset += 4; // "WAVE"
            
            // fmt
            view.setUint32(offset, 0x20746d66, false); offset += 4; // "fmt "
            view.setUint32(offset, 16, true); offset += 4; // fmt chunk size
            view.setUint16(offset, 1, true); offset += 2; // PCM format
            view.setUint16(offset, 1, true); offset += 2; // 1 channel
            view.setUint32(offset, sampleRate, true); offset += 4; // sample rate
            view.setUint32(offset, sampleRate * 2, true); offset += 4; // byte rate
            view.setUint16(offset, 2, true); offset += 2; // block align
            view.setUint16(offset, 16, true); offset += 2; // 16 bits per sample
            
            // data
            view.setUint32(offset, 0x61746164, false); offset += 4; // "data"
            view.setUint32(offset, samples * 2, true); offset += 4; // data size
            
            // 生成简单的音频数据（440Hz正弦波）
            for (let i = 0; i < samples; i++) {
                const sample = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 0.3;
                const intSample = Math.round(sample * 32767);
                view.setInt16(offset, intSample, true);
                offset += 2;
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        recordBtn.addEventListener('click', async () => {
            try {
                addLog('开始5秒录音测试...');
                updateResult('正在录音...', '');
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];
                
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(chunks, { type: mediaRecorder.mimeType });
                    addLog(`录音完成: ${audioBlob.size} bytes, ${mediaRecorder.mimeType}`);
                    
                    // 直接发送原始录音
                    await testRecognition(audioBlob, '原始录音');
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                recordBtn.disabled = true;
                
                // 5秒后自动停止
                setTimeout(() => {
                    mediaRecorder.stop();
                    recordBtn.disabled = false;
                    addLog('录音已停止');
                }, 5000);
                
            } catch (error) {
                addLog(`录音失败: ${error.message}`);
                updateResult(`录音失败: ${error.message}`, 'error');
            }
        });
        
        testWavBtn.addEventListener('click', async () => {
            addLog('测试生成的WAV文件...');
            const wavBlob = createMinimalWav();
            addLog(`生成WAV文件: ${wavBlob.size} bytes`);
            await testRecognition(wavBlob, '生成的WAV');
        });
        
        testTextBtn.addEventListener('click', async () => {
            addLog('测试固定文本识别...');
            
            try {
                // 直接调用后端API测试
                const response = await fetch('/api/voice_recognition', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test: true,
                        text: '你好世界'
                    })
                });
                
                const result = await response.text();
                addLog(`后端响应: ${result}`);
                
                if (response.ok) {
                    updateResult('后端API正常响应', 'success');
                } else {
                    updateResult('后端API响应异常', 'error');
                }
                
            } catch (error) {
                addLog(`API测试失败: ${error.message}`);
                updateResult(`API连接失败: ${error.message}`, 'error');
            }
        });
        
        async function testRecognition(audioBlob, source) {
            try {
                addLog(`开始测试${source}识别...`);
                updateResult(`正在识别${source}...`, '');
                
                const formData = new FormData();
                const extension = audioBlob.type.includes('wav') ? 'wav' : 'webm';
                const audioFile = new File([audioBlob], `test.${extension}`, {
                    type: audioBlob.type
                });
                formData.append('audio', audioFile);
                
                addLog(`发送文件: ${audioFile.name}, ${audioFile.size} bytes, ${audioFile.type}`);
                
                const response = await fetch('/api/voice_recognition', {
                    method: 'POST',
                    body: formData
                });
                
                addLog(`HTTP状态: ${response.status}`);
                
                const responseText = await response.text();
                addLog(`原始响应: ${responseText}`);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    addLog(`JSON解析失败: ${e.message}`);
                    updateResult(`响应格式错误`, 'error');
                    return;
                }
                
                if (data.success) {
                    const text = data.text || '';
                    addLog(`识别成功: "${text}"`);
                    
                    if (text.includes('我不知道') || text.includes('不知道')) {
                        updateResult(`⚠️ 仍然返回"我不知道": ${text}`, 'warning');
                        addLog('❌ 问题依然存在！');
                        
                        // 详细分析
                        addLog('🔍 可能的原因:');
                        addLog('   1. 音频数据确实无效或损坏');
                        addLog('   2. 百度API配置问题');
                        addLog('   3. 音频格式仍然不兼容');
                        addLog('   4. 录音环境噪音过大');
                        addLog('   5. 说话内容不够清晰');
                        
                    } else if (text.trim() === '') {
                        updateResult('⚠️ 识别结果为空', 'warning');
                        addLog('可能是静音或音频无效');
                    } else {
                        updateResult(`✅ 识别成功: "${text}"`, 'success');
                        addLog('🎉 识别正常！问题已解决');
                    }
                    
                    if (data.confidence) {
                        addLog(`置信度: ${data.confidence}`);
                    }
                } else {
                    addLog(`识别失败: ${data.error}`);
                    updateResult(`识别失败: ${data.error}`, 'error');
                    
                    if (data.error_code) {
                        addLog(`错误码: ${data.error_code}`);
                    }
                }
                
            } catch (error) {
                addLog(`测试失败: ${error.message}`);
                updateResult(`测试失败: ${error.message}`, 'error');
            }
        }
        
        // 初始化
        addLog('🎯 直接ASR测试工具已加载');
        addLog('📋 测试选项:');
        addLog('   1. "录音5秒" - 录制真实语音测试');
        addLog('   2. "测试WAV文件" - 使用生成的标准WAV文件');
        addLog('   3. "测试固定文本" - 测试后端API连接');
        addLog('');
        addLog('💡 建议先测试"测试WAV文件"确认格式是否正确');
    </script>
</body>
</html>
